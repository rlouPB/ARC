<template>
    <div class="slds"> 
		<!-- <lightning-card class="outerCard"> -->
			<template if:true={caseAbstract}>
				<lightning-layout >
					<lightning-layout-item class="slds-var-p-right_large" size={pageColumns.mainWidth} >
						<template if:false={isFinalized}>
							<template if:true={caseAbstract.hasPresentation}>
								<!--a target="_blank" href={caseAbstract.presentation.previewUrl} title={caseAbstract.presentation.version.Title}-->
								<a target="_blank" href={presentationUrl} title={caseAbstract.presentation.version.Title}>
									<lightning-card class="presentationCard slds-card_boundary slds-card_boundary">
										<div slot="title" >
											<h3 >
												<lightning-icon icon-name="action:clone" size="small" ></lightning-icon>
												Latest Case Abstract Presentation
											</h3>
										</div>
										<div slot="footer" class="slds-text-align_left">
											<p>Generated by {caseAbstract.record.Presentation_Generated_By__c}</p>
											<p><lightning-formatted-date-time value={generatedDateTimeInteger} year="numeric" month="short" day="2-digit" weekday="long" hour="2-digit" minute="2-digit" time-zone-name="short" hour12="true" time-zone="America/New_York"></lightning-formatted-date-time></p>
										</div>
									</lightning-card>
								</a>
							</template>
						</template>
						<lightning-card class="mainCard">
							<template if:true={caseAbstract.sections}>
								<lightning-layout multiple-rows="true">
									<lightning-layout-item size="12" >
										<div class="slds-text-heading_large slds-m-left_small" >
											Case Abstract Sections
										</div>
									</lightning-layout-item>
									<template for:each={caseAbstract.sections} for:item=section >										
											<lightning-layout-item key={section.record.Id} size="12" >
												<template if:true={isFinalized}>
													<template if:true={section.isCompleted}>
														<div class="slds-m-left_medium slds-m-top_medium item-section-header">
															{section.sectionMdt.Section_Number__c}&nbsp;{section.sectionMdt.Title__c} 
														</div>
														<div class="slds-m-left_medium">
															<template for:each={section.items} for:item="item">
																<lightning-formatted-rich-text key={section.record.Id} value={item.sectionFieldValue}></lightning-formatted-rich-text>
															</template>
														</div>
													</template>
													<template if:true={section.isCompleted}>
														<lightning-layout-item key={section.record.Id} size="3" >
															<p ></p>&nbsp;&nbsp;</p>
														</lightning-layout-item>
														<lightning-layout-item key={section.record.Id} size="9" >
															<p class="slds-m-left_medium">Completed By {section.record.Completed_By_Professional_Name__c}&nbsp;at&nbsp;{section.completedDateTimeString}</p>
														</lightning-layout-item>
													</template>
												</template>
												<template if:false={isFinalized}>
													<c-case-abstract-section-lwc section-read-only={section} case-abstract-status={caseAbstractStatus} onrefreshcaseabstract={refreshCaseAbstract} ></c-case-abstract-section-lwc>
												</template>
											</lightning-layout-item>
											
									</template> 
								</lightning-layout>
							</template>
						</lightning-card>	
					</lightning-layout-item>
					<lightning-layout-item size={pageColumns.sidebarWidth} >
						<c-patient-sidebar-lwc patient-account-id={caseAbstract.patientId} 
												record-id={recordId}>										
							<div slot="sideBarFooter" >	
								<lightning-layout multiple-rows >									
									<lightning-layout-item size="12"  padding="horizontal-large">
										<button class="slds-button slds-button_brand slds-button_stretch slds-var-m-top_x-small" label="Generate Presentation"  disabled={disableGeneratePresentation} onclick={handleGeneratePresentation}>Generate Presentation</button>
									</lightning-layout-item>
									<lightning-layout-item size="12" padding="horizontal-large" >
										<button class="slds-button slds-button_brand slds-button_stretch slds-var-m-top_x-small" label="View Presentation" disabled={disableViewPresentation} onclick={handleViewPresentaion}>View Presentation</button>
									</lightning-layout-item>
									
									<lightning-layout-item size="12"  padding="horizontal-large">
										<button class="slds-button slds-button_brand slds-button_stretch slds-var-m-top_x-small" label="Send As Message" disabled={disableViewPresentation} onclick={handleSendAsMessage}>Send As Message</button>
									</lightning-layout-item>
									
									<template if:false={isFinalized}>
										<lightning-layout-item size="12" padding="horizontal-large" >
											<button class="slds-button slds-button_brand slds-button_stretch slds-var-m-top_x-small" label="Finalize"  disabled={disableGeneratePresentation} onclick={showConfirmationBox}>Finalize</button>
										</lightning-layout-item>
									</template>
									<template if:true={canReopen}>
										<lightning-layout-item size="12" padding="horizontal-large" >
											<button class="slds-button slds-button_brand slds-button_stretch slds-var-m-top_x-small" label="Re-Open" onclick={showReOpenConfirmation}>Re-Open</button>
										</lightning-layout-item>
									</template>
									
								</lightning-layout>
								
							</div>
							<div slot="sideBarBody" >
								<lightning-layout-item size="12" >
									<div class="slds-var-m-left_medium">
										<template if:true={caseAbstract.assignedClinicianNameMap.Psychotherapist}>
											<p>Psychotherapist:</p>
											<p>&nbsp;&nbsp;{caseAbstract.assignedClinicianNameMap.Psychotherapist}</p>
										</template>
									</div>
								</lightning-layout-item>
							</div>		
						</c-patient-sidebar-lwc>
					</lightning-layout-item>
				</lightning-layout>
			</template>
			<template if:false={caseAbstract}>
				<lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
			</template>

			<template if:true={showSpinner}>
				<lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
			</template>
		<!-- </lightning-card> -->

    </div>    

	<template if:true={showCreateMessageModal} >
		<c-modal-lwc onclose={closeCreateMessageBox} show-footer="true">
			<c-create-user-group-message></c-create-user-group-message>
			<div slot="header">
				Send As Message
			</div>
			<div slot="footer">
				<div class="modal-footer slds-modal__footer">
					<lightning-button
										id="cancel-message-box-button"
										label="Cancel"
										title="Cancel"
										variant="neutral"
										class="slds-m-left_x-small slds-button_text-destructive"
										onclick={closeCreateMessageBox}>
					</lightning-button>
					<lightning-button
										id="send-button"
										label="Send"
										title="Send"
										variant="brand"
										class="slds-m-left_x-small"
										onclick={sendMessage}>
					</lightning-button>
					</div>
			</div>
			<a class="previewUrl" target="_blank" href={caseAbstract.presentation.latestCaseAbstractVerion} title={caseAbstract.presentation.version.Title} >Latest Case Abstract Presentation </a>
		</c-modal-lwc>
	</template>
    <!-- <c-modal-popup-lwc class="popup" ></c-modal-popup-lwc> -->
	<template if:true={showConfirmModal} >
		<c-modal-lwc onclose={closeConfirmationBox} show-footer="true">
			<div slot="header">
				Confirmation
			</div>
			<div slot="footer">
				<div class="modal-footer slds-modal__footer">
					<lightning-button
										id="cancel-button"
										label="Cancel"
										title="Cancel"
										variant="neutral"
										class="slds-m-left_x-small slds-button_text-destructive"
										onclick={closeConfirmationBox}>
					</lightning-button>
					<lightning-button
										id="save-button"
										label="Finalize"
										title="Finalize"
										variant="brand"
										class="slds-m-left_x-small"
										onclick={handleFinalize}>
					</lightning-button>
					</div>
			</div>
			{confirmationModalText}
		</c-modal-lwc>
	</template>
	
	<template if:true={showReOpenConfirmationModal} >
		<c-modal-lwc onclose={closeReOpenConfirmationModal} show-footer="true">
			<div slot="header">
				Confirmation
			</div>
			<div slot="footer">
				<div class="modal-footer slds-modal__footer">
					<lightning-button
										id="cancel-re-open-button"
										label="Cancel"
										title="Cancel"
										variant="neutral"
										class="slds-m-left_x-small slds-button_text-destructive"
										onclick={closeReOpenConfirmationModal}>
					</lightning-button>
					<lightning-button
										id="save-re-open-button"
										label="Re-Open"
										title="Re-Open"
										variant="brand"
										class="slds-m-left_x-small"
										onclick={handleReOpen}>
					</lightning-button>
					</div>
			</div>
			{reOpenconfirmationModalText}
		</c-modal-lwc>
	</template>
</template>